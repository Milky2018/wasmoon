# Wasmoon Roadmap

WebAssembly Runtime in MoonBit - å¼€å‘è·¯çº¿å›¾

## é¡¹ç›®æ¦‚è¿°

Wasmoon æ˜¯ä¸€ä¸ªç”¨ MoonBit ç¼–å†™çš„ WebAssembly è¿è¡Œæ—¶ï¼Œç›®æ ‡æ˜¯å®ç°ä¸€ä¸ªå®Œæ•´çš„ WASM è§£é‡Šå™¨å’Œ JIT ç¼–è¯‘å™¨ï¼Œæ”¯æŒ WebAssembly è§„èŒƒçš„æ ¸å¿ƒç‰¹æ€§ï¼Œå¹¶æœ€ç»ˆå®ç°ç±»ä¼¼ Cranelift çš„ä»£ç ç”Ÿæˆå™¨ã€‚

## å½“å‰çŠ¶æ€

**WAST å®˜æ–¹æµ‹è¯•å¥—ä»¶ 100% é€šè¿‡** (72/72 æ–‡ä»¶, 18764 æµ‹è¯•)

---

## å·²å®Œæˆçš„é˜¶æ®µ

| é˜¶æ®µ | å†…å®¹ | çŠ¶æ€ |
|------|------|------|
| Phase 1 | MVP - æ ¸å¿ƒæ•°æ®ç»“æ„ã€äºŒè¿›åˆ¶è§£æã€è¿è¡Œæ—¶ã€åŸºç¡€æ‰§è¡Œå¼•æ“ | âœ… |
| Phase 2 | æ ¸å¿ƒåŠŸèƒ½æ‰©å±• - i64/f32/f64 è¿ç®—ã€å†…å­˜æ“ä½œã€æ§åˆ¶æµã€å‡½æ•°è°ƒç”¨ | âœ… |
| Phase 3 | WASM 1.0 å®Œæ•´æ”¯æŒ - å…¨å±€å˜é‡ã€å¯¼å…¥å¯¼å‡ºã€è¡¨æ“ä½œã€æ¨¡å—åˆå§‹åŒ–ã€æ‰¹é‡å†…å­˜ã€å¼•ç”¨ç±»å‹ã€å¤šè¿”å›å€¼ | âœ… |
| Phase 4 | æ¨¡å—éªŒè¯ä¸é“¾æ¥ - ç±»å‹æ£€æŸ¥ã€æ ˆéªŒè¯ã€æ§åˆ¶æµéªŒè¯ã€å¤šæ¨¡å—é“¾æ¥ | âœ… |
| Phase 5 | å·¥å…·ä¸æµ‹è¯• - å®˜æ–¹æµ‹è¯•å¥—ä»¶ã€WAT è§£æã€CLI å·¥å…·é“¾ã€é”™è¯¯æŠ¥å‘Š | âœ… |
| Phase 6 | ä¸­é—´è¡¨ç¤ºå±‚ (IR) - SSA IRã€CFGã€WASMâ†’IR è½¬æ¢ã€IR éªŒè¯ | âœ… |
| Phase 7 | IR ä¼˜åŒ– - DCEã€å¸¸é‡æŠ˜å /ä¼ æ’­ã€CSEã€æ§åˆ¶æµä¼˜åŒ–ã€å¾ªç¯ä¼˜åŒ– | âœ… |
| Phase 8 | ä½çº§ IR ä¸æŒ‡ä»¤é€‰æ‹© - VCodeã€Loweringã€ç›®æ ‡æ¶æ„æŠ½è±¡ | âœ… æ ¸å¿ƒå®Œæˆ |
| Phase 9 | å¯„å­˜å™¨åˆ†é… - æ´»è·ƒæ€§åˆ†æã€çº¿æ€§æ‰«æã€æº¢å‡ºå¤„ç†ã€æ ˆå¸ƒå±€ | âœ… æ ¸å¿ƒå®Œæˆ |
| Phase 10 | ä»£ç ç”Ÿæˆ - AArch64 åç«¯ã€ä»£ç å‘å°„ã€è¿è¡Œæ—¶æ”¯æŒ | âœ… æ ¸å¿ƒå®Œæˆ |
| Phase 11 | JIT è¿è¡Œæ—¶é›†æˆ - æ··åˆæ‰§è¡Œã€.cwasm é¢„ç¼–è¯‘ã€è°ƒè¯•æ”¯æŒ | âœ… æ ¸å¿ƒå®Œæˆ |
| Phase 12 | WASI Preview 1 - I/Oã€æ–‡ä»¶ç³»ç»Ÿã€ç¯å¢ƒå˜é‡ã€æ—¶é’Ÿã€è¿›ç¨‹æ§åˆ¶ | âœ… |
| Phase 14-15 | å®˜æ–¹æµ‹è¯•å¥—ä»¶ 100% é€šè¿‡ | âœ… |

---

## è¿›è¡Œä¸­ & è®¡åˆ’ä¸­

### Phase 11.4: JIT æµ‹è¯•é›†æˆ ğŸ“‹

> å°† JIT ç¼–è¯‘å™¨é›†æˆåˆ° `wasmoon test` å‘½ä»¤

**å½“å‰çŠ¶æ€**:
- `wasmoon run` æ”¯æŒ JITï¼ˆ`--no-jit` ç¦ç”¨ï¼‰
- `wasmoon test` ä»…ä½¿ç”¨è§£é‡Šå™¨
- JIT trampoline ä»…æ”¯æŒ WASI (`fd_write`, `proc_exit`)

**å®ç°æ­¥éª¤**:
- [ ] å®ç° spectest æ¨¡å—çš„ JIT trampolines (`print_i32/i64/f32/f64` ç­‰)
- [ ] åœ¨ `wasmoon test` æ·»åŠ  `--jit` æ ‡å¿—
- [ ] æ··åˆæ‰§è¡Œæ¨¡å¼ï¼šæŒ‰æ¨¡å—è‡ªåŠ¨é€‰æ‹© JIT/è§£é‡Šå™¨
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•

---

### Phase 13: WASM æ‰©å±•ææ¡ˆ ğŸŒŸ

#### 13.1 WASM 2.0+ ç‰¹æ€§
- [ ] å°¾è°ƒç”¨ (tail-call)
- [ ] å¼‚å¸¸å¤„ç† (exception-handling)
- [ ] ç»„ä»¶æ¨¡å‹ (Component Model)

#### 13.2 åƒåœ¾å›æ”¶ (WasmGC)
- [ ] ç±»å‹ç³»ç»Ÿæ‰©å±• (struct, array, ç±»å‹å±‚æ¬¡)
- [ ] æŒ‡ä»¤é›†æ‰©å±• (struct.new/get/set, array.*, ref.cast/test)
- [ ] è¿è¡Œæ—¶æ”¯æŒ (GC å †, å¯¹è±¡å¸ƒå±€)

#### 13.3 SIMD æ”¯æŒ
- [ ] v128 ç±»å‹
- [ ] SIMD æŒ‡ä»¤é›†
- [ ] å‘é‡åŒ–ä¼˜åŒ–

#### 13.4 çº¿ç¨‹æ”¯æŒ
- [ ] å…±äº«å†…å­˜
- [ ] åŸå­æ“ä½œ
- [ ] ç­‰å¾…/é€šçŸ¥

---

## å¾…å®Œå–„é¡¹

| ä»»åŠ¡ | é˜¶æ®µ | ä¼˜å…ˆçº§ |
|------|------|--------|
| å¯„å­˜å™¨åˆå¹¶ (Coalescing) | Phase 9 | P1 |
| æ‰©å±•æŒ‡ä»¤ (ExtendKind) | Phase 10 | P1 |
| JIT æµ‹è¯•é›†æˆ | Phase 11 | P2 |
| å †æ ˆæ›¿æ¢ (OSR) | Phase 11 | P2 |
| å®Œæ•´è°ƒè¯•å‘½ä»¤ (Step*) | Phase 11 | P2 |
| x86-64 åç«¯ | Phase 10 | P3 |

---

## å‚è€ƒèµ„æº

- [WebAssembly Specification](https://webassembly.github.io/spec/)
- [Cranelift Official Site](https://cranelift.dev/)
- [ISLE DSL Reference](https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/isle/docs/language-reference.md)

---

## å†å²é—®é¢˜ï¼ˆå·²è§£å†³ï¼‰

### ~~MoonBit æ¡ä»¶è¡¨è¾¾å¼æµ®ç‚¹é›¶ Bug~~ (å·²ä¿®å¤)

`if neg { -0.0 } else { 0.0 }` åœ¨ `neg = false` æ—¶é”™è¯¯è¿”å› `-0.0`ã€‚

**çŠ¶æ€**: MoonBit å·²åœ¨æœ€æ–°ç‰ˆæœ¬ä¸­ä¿®å¤æ­¤é—®é¢˜ã€‚

**å›å½’æµ‹è¯•**: `wat/parser_wbtest.mbt` ä¸­çš„ `test "regression: conditional 0.0 vs -0.0 now works correctly"`
