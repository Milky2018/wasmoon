# Wasmoon Roadmap

WebAssembly Runtime in MoonBit - å¼€å‘è·¯çº¿å›¾

## é¡¹ç›®æ¦‚è¿°

Wasmoon æ˜¯ä¸€ä¸ªç”¨ MoonBit ç¼–å†™çš„ WebAssembly è¿è¡Œæ—¶ï¼Œç›®æ ‡æ˜¯å®ç°ä¸€ä¸ªå®Œæ•´çš„ WASM è§£é‡Šå™¨å’Œ JIT ç¼–è¯‘å™¨ï¼Œæ”¯æŒ WebAssembly è§„èŒƒçš„æ ¸å¿ƒç‰¹æ€§ï¼Œå¹¶æœ€ç»ˆå®ç°ç±»ä¼¼ Cranelift çš„ä»£ç ç”Ÿæˆå™¨ã€‚

## Phase 1: MVP âœ… å·²å®Œæˆ

### 1.1 æ ¸å¿ƒæ•°æ®ç»“æ„ âœ…
- [x] å€¼ç±»å‹å®šä¹‰ (I32, I64, F32, F64, FuncRef, ExternRef)
- [x] æŒ‡ä»¤é›†æšä¸¾ (190+ æŒ‡ä»¤å˜ä½“)
- [x] æ¨¡å—ç»“æ„ (Module, FuncType, Export, Import ç­‰)

### 1.2 äºŒè¿›åˆ¶æ ¼å¼è§£æå™¨ âœ…
- [x] é­”æ•°å’Œç‰ˆæœ¬éªŒè¯
- [x] LEB128 ç¼–ç è§£ç 
- [x] 11 ç§ Section è§£æ
- [x] IEEE 754 æµ®ç‚¹æ•°è§£ç  (f32/f64)

### 1.3 è¿è¡Œæ—¶æ•°æ®ç»“æ„ âœ…
- [x] æ“ä½œæ•°æ ˆ (Stack)
- [x] çº¿æ€§å†…å­˜ (Memory)
- [x] å‡½æ•°å¼•ç”¨è¡¨ (Table)
- [x] å…¨å±€å˜é‡ (GlobalInstance)
- [x] è°ƒç”¨å¸§ (Frame)
- [x] å…¨å±€å­˜å‚¨ (Store)
- [x] æ¨¡å—å®ä¾‹ (ModuleInstance)

### 1.4 åŸºç¡€æ‰§è¡Œå¼•æ“ âœ…
- [x] i32 ç®—æœ¯/æ¯”è¾ƒ/ä½è¿ç®—
- [x] å¸¸é‡æŒ‡ä»¤
- [x] å±€éƒ¨å˜é‡æ“ä½œ
- [x] åŸºæœ¬æ§åˆ¶æµ

---

## Phase 2: æ ¸å¿ƒåŠŸèƒ½æ‰©å±• âœ… å·²å®Œæˆ

### 2.1 å®Œæ•´çš„æ•°å€¼è¿ç®— âœ…
- [x] i64 ç®—æœ¯/æ¯”è¾ƒ/ä½è¿ç®—
- [x] f32/f64 æµ®ç‚¹è¿ç®—
- [x] æ•°å€¼è½¬æ¢æŒ‡ä»¤ (wrap, extend, trunc, convert, reinterpret)
- [x] é¥±å’Œè½¬æ¢æŒ‡ä»¤ (trunc_sat)

### 2.2 å†…å­˜æ“ä½œ âœ…
- [x] å®Œæ•´çš„ load/store æŒ‡ä»¤æ—
- [x] æ‰©å±•çš„ load æŒ‡ä»¤ (load8_s, load8_u, load16_s, load16_u, load32_s, load32_u)
- [x] memory.size å’Œ memory.grow

### 2.3 æ§åˆ¶æµ âœ…
- [x] ç»“æ„åŒ–æ§åˆ¶æµ (block, loop, if-else)
- [x] åˆ†æ”¯æŒ‡ä»¤ (br, br_if, br_table)
- [x] select æŒ‡ä»¤

### 2.4 å‡½æ•°è°ƒç”¨ âœ…
- [x] ç›´æ¥å‡½æ•°è°ƒç”¨ (call)
- [x] é—´æ¥å‡½æ•°è°ƒç”¨ (call_indirect)

---

## Phase 3: å®Œæ•´çš„ WASM 1.0 æ”¯æŒ âœ… å·²å®Œæˆ

### 3.1 å…¨å±€å˜é‡ âœ…
- [x] global.get / global.set
- [x] å…¨å±€å˜é‡åˆå§‹åŒ–è¡¨è¾¾å¼

### 3.2 å¯¼å…¥å¯¼å‡º âœ…
- [x] å‡½æ•°å¯¼å…¥/å¯¼å‡º
- [x] ä¸»æœºå‡½æ•°æ¥å£ (Host Functions)
- [x] å†…å­˜å¯¼å…¥/å¯¼å‡º
- [x] è¡¨å¯¼å…¥/å¯¼å‡º
- [x] å…¨å±€å˜é‡å¯¼å…¥/å¯¼å‡º

### 3.3 è¡¨æ“ä½œ âœ…
- [x] table.get / table.set
- [x] table.size / table.grow
- [x] table.fill / table.copy

### 3.4 æ¨¡å—åˆå§‹åŒ– âœ…
- [x] Start function æ‰§è¡Œ
- [x] æ•°æ®æ®µåˆå§‹åŒ– (data segment)
- [x] å…ƒç´ æ®µåˆå§‹åŒ– (element segment)

### 3.5 æ‰¹é‡å†…å­˜æ“ä½œ âœ…
- [x] memory.init / memory.copy / memory.fill
- [x] data.drop / elem.drop

### 3.6 å¼•ç”¨ç±»å‹ âœ…
- [x] ref.null / ref.is_null / ref.func

### 3.7 å¤šè¿”å›å€¼ âœ…
- [x] å‡½æ•°å¤šè¿”å›å€¼æ”¯æŒ
- [x] block/if å¤šè¿”å›å€¼æ”¯æŒ

---

## Phase 4: æ¨¡å—éªŒè¯ä¸é“¾æ¥ âœ… å·²å®Œæˆ

### 4.1 æ¨¡å—éªŒè¯å™¨ âœ…
- [x] ç±»å‹æ£€æŸ¥
- [x] æ ˆé«˜åº¦éªŒè¯
- [x] æ§åˆ¶æµéªŒè¯
- [x] å†…å­˜é™åˆ¶éªŒè¯
- [x] å¤šå†…å­˜/å¤šè¡¨æ£€æŸ¥ (MVP é™åˆ¶)

### 4.2 å¤šæ¨¡å—æ”¯æŒ âœ…
- [x] æ¨¡å—é“¾æ¥
- [x] ç¬¦å·è§£æ

---

## Phase 5: å·¥å…·ä¸æµ‹è¯• âœ… å·²å®Œæˆ

### 5.1 è§„èŒƒå…¼å®¹æ€§ âœ…
- [x] å®˜æ–¹æµ‹è¯•å¥—ä»¶åŸºç¡€è®¾æ–½ (wasm-testsuite)
- [x] è‡ªåŠ¨åŒ–æµ‹è¯•è¿è¡Œå™¨ (è§£æ JSON æµ‹è¯•è§„èŒƒï¼Œè‡ªåŠ¨æ‰§è¡Œæµ‹è¯•)
  - ç”¨æ³•: `moon run cmd/main -- test testsuite/data/i32.json`
- [x] å®Œæ•´é€šè¿‡å®˜æ–¹æµ‹è¯•å¥—ä»¶ (5955 tests passed, 0 failed)

### 5.2 å·¥å…·é“¾
- [ ] WAT æ–‡æœ¬æ ¼å¼æ”¯æŒ
- [ ] WASM åæ±‡ç¼–å™¨

---

## Phase 6: ä¸­é—´è¡¨ç¤ºå±‚ (IR) ğŸ”¨ è¿›è¡Œä¸­

> è¿™æ˜¯å®ç° JIT ç¼–è¯‘å™¨çš„åŸºç¡€ï¼Œå‚è€ƒ [Cranelift](https://cranelift.dev/) çš„è®¾è®¡

### 6.1 é«˜çº§ IR (ç±»ä¼¼ CLIF)
- [ ] SSA (Static Single Assignment) å½¢å¼çš„ IR å®šä¹‰
- [ ] åŸºæœ¬å— (Basic Block) æ•°æ®ç»“æ„
- [ ] æ§åˆ¶æµå›¾ (CFG) æ„å»º
- [ ] IR ç±»å‹ç³»ç»Ÿ (ä¸ WASM ç±»å‹å¯¹åº”)
- [ ] IR æŒ‡ä»¤é›†å®šä¹‰
  - [ ] ç®—æœ¯è¿ç®—æŒ‡ä»¤
  - [ ] å†…å­˜è®¿é—®æŒ‡ä»¤
  - [ ] æ§åˆ¶æµæŒ‡ä»¤
  - [ ] å‡½æ•°è°ƒç”¨æŒ‡ä»¤

### 6.2 WASM åˆ° IR çš„è½¬æ¢
- [ ] WASM æŒ‡ä»¤åˆ° IR æŒ‡ä»¤çš„æ˜ å°„
- [ ] æ ˆæœºæ¨¡å‹åˆ°å¯„å­˜å™¨æ¨¡å‹çš„è½¬æ¢
- [ ] æ§åˆ¶æµé‡å»º (block/loop/if åˆ° CFG)
- [ ] å±€éƒ¨å˜é‡å’Œå‚æ•°å¤„ç†

### 6.3 IR éªŒè¯
- [ ] SSA å±æ€§éªŒè¯
- [ ] ç±»å‹ä¸€è‡´æ€§æ£€æŸ¥
- [ ] æ§åˆ¶æµå®Œæ•´æ€§éªŒè¯

---

## Phase 7: IR ä¼˜åŒ– âš¡

> åœ¨é«˜çº§ IR ä¸Šè¿›è¡Œç›®æ ‡æ— å…³çš„ä¼˜åŒ–

### 7.1 åŸºç¡€ä¼˜åŒ–
- [ ] æ­»ä»£ç æ¶ˆé™¤ (Dead Code Elimination)
- [ ] å¸¸é‡æŠ˜å  (Constant Folding)
- [ ] å¸¸é‡ä¼ æ’­ (Constant Propagation)
- [ ] å¤åˆ¶ä¼ æ’­ (Copy Propagation)
- [ ] å…¬å…±å­è¡¨è¾¾å¼æ¶ˆé™¤ (CSE)

### 7.2 æ§åˆ¶æµä¼˜åŒ–
- [ ] åˆ†æ”¯ç®€åŒ–
- [ ] ä¸å¯è¾¾ä»£ç æ¶ˆé™¤
- [ ] åŸºæœ¬å—åˆå¹¶
- [ ] è·³è½¬çº¿ç¨‹åŒ– (Jump Threading)

### 7.3 å¾ªç¯ä¼˜åŒ–
- [ ] å¾ªç¯ä¸å˜ä»£ç å¤–æ (LICM)
- [ ] å¾ªç¯å±•å¼€ (Loop Unrolling)
- [ ] å¼ºåº¦å‰Šå‡ (Strength Reduction)

### 7.4 é«˜çº§ä¼˜åŒ– (å¯é€‰)
- [ ] E-graph ç»Ÿä¸€ä¼˜åŒ–æ¡†æ¶ (å‚è€ƒ Cranelift çš„åˆ›æ–°è®¾è®¡)
- [ ] å†…è” (Inlining)
- [ ] å°¾è°ƒç”¨ä¼˜åŒ–

---

## Phase 8: ä½çº§ IR ä¸æŒ‡ä»¤é€‰æ‹© ğŸ”§

> ç±»ä¼¼ Cranelift çš„ VCodeï¼Œç›®æ ‡ç›¸å…³çš„ä½çº§è¡¨ç¤º

### 8.1 ä½çº§ IR (VCode) è®¾è®¡
- [ ] è™šæ‹Ÿå¯„å­˜å™¨è¡¨ç¤º
- [ ] ç›®æ ‡ç›¸å…³çš„æŒ‡ä»¤æ ¼å¼
- [ ] é SSA å½¢å¼ (å…è®¸é‡å®šä¹‰)
- [ ] å¯„å­˜å™¨çº¦æŸè¡¨ç¤º

### 8.2 æŒ‡ä»¤é€‰æ‹© (Lowering)
- [ ] é«˜çº§ IR åˆ°ä½çº§ IR çš„è½¬æ¢æ¡†æ¶
- [ ] æ¨¡å¼åŒ¹é…è§„åˆ™å®šä¹‰ (ç±»ä¼¼ ISLE DSL)
- [ ] æŒ‡ä»¤åˆå¹¶ä¸ä¼˜åŒ–
- [ ] ç›®æ ‡ç‰¹å®šçš„æŒ‡ä»¤é€‰æ‹©è§„åˆ™

### 8.3 ç›®æ ‡æ¶æ„æŠ½è±¡
- [ ] ç›®æ ‡æ¶æ„æ¥å£ (TargetISA trait)
- [ ] å¯„å­˜å™¨æè¿°
- [ ] è°ƒç”¨çº¦å®š (Calling Convention)
- [ ] æŒ‡ä»¤ç¼–ç è§„åˆ™

---

## Phase 9: å¯„å­˜å™¨åˆ†é… ğŸ“Š

> å°†è™šæ‹Ÿå¯„å­˜å™¨æ˜ å°„åˆ°ç‰©ç†å¯„å­˜å™¨

### 9.1 æ´»è·ƒæ€§åˆ†æ
- [ ] æ´»è·ƒåŒºé—´ (Live Interval) è®¡ç®—
- [ ] ä½¿ç”¨-å®šä¹‰é“¾ (Use-Def Chain)

### 9.2 å¯„å­˜å™¨åˆ†é…ç®—æ³•
- [ ] çº¿æ€§æ‰«æåˆ†é…å™¨ (Linear Scan)
- [ ] æº¢å‡ºå¤„ç† (Spilling)
- [ ] é‡æ–°åŠ è½½ (Reloading)
- [ ] å¯„å­˜å™¨åˆå¹¶ (Coalescing)

### 9.3 æ ˆå¸ƒå±€
- [ ] æ ˆå¸§å¸ƒå±€è®¡ç®—
- [ ] æº¢å‡ºæ§½åˆ†é…
- [ ] è°ƒç”¨è€…/è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨å¤„ç†

---

## Phase 10: ä»£ç ç”Ÿæˆ ğŸ’»

> ç”Ÿæˆç›®æ ‡å¹³å°çš„æœºå™¨ä»£ç 

### 10.1 x86-64 åç«¯
- [ ] æŒ‡ä»¤ç¼–ç 
- [ ] å¯»å€æ¨¡å¼
- [ ] æ¡ä»¶ç å¤„ç†
- [ ] æµ®ç‚¹æŒ‡ä»¤ (SSE/AVX)

### 10.2 AArch64 åç«¯ (å¯é€‰)
- [ ] æŒ‡ä»¤ç¼–ç 
- [ ] å¯„å­˜å™¨ä½¿ç”¨
- [ ] æ¡ä»¶æ‰§è¡Œ

### 10.3 ä»£ç å‘å°„
- [ ] æœºå™¨ç ç¼“å†²åŒº
- [ ] é‡å®šä½å¤„ç†
- [ ] åˆ†æ”¯åç§»è®¡ç®—
- [ ] ä»£ç å¯¹é½

### 10.4 è¿è¡Œæ—¶æ”¯æŒ
- [ ] JIT ä»£ç ç¼“å­˜
- [ ] å¯æ‰§è¡Œå†…å­˜ç®¡ç†
- [ ] ä»£ç å¸è½½

---

## Phase 11: JIT è¿è¡Œæ—¶é›†æˆ ğŸš€

> å°† JIT ç¼–è¯‘å™¨é›†æˆåˆ° WASM è¿è¡Œæ—¶

### 11.1 ç¼–è¯‘ç­–ç•¥
- [ ] è§£é‡Šæ‰§è¡Œ + JIT æ··åˆæ¨¡å¼
- [ ] çƒ­ç‚¹æ£€æµ‹ (Profiling)
- [ ] åˆ†å±‚ç¼–è¯‘ (Tiered Compilation)
- [ ] æ‡’ç¼–è¯‘ (Lazy Compilation)

### 11.2 è¿è¡Œæ—¶æ¥å£
- [ ] ç¼–è¯‘å‡½æ•°è°ƒç”¨
- [ ] è§£é‡Šå™¨åˆ° JIT ä»£ç çš„åˆ‡æ¢
- [ ] å †æ ˆæ›¿æ¢ (On-Stack Replacement)

### 11.3 è°ƒè¯•æ”¯æŒ
- [ ] æºç æ˜ å°„
- [ ] æ–­ç‚¹æ”¯æŒ
- [ ] å †æ ˆè·Ÿè¸ª

---

## Phase 12: WASM æ‰©å±•ææ¡ˆ ğŸŒŸ

### 12.1 WASM 2.0+ ç‰¹æ€§
- [ ] å°¾è°ƒç”¨ (tail-call)
- [ ] å¼‚å¸¸å¤„ç† (exception-handling)
- [ ] åƒåœ¾å›æ”¶ (GC)
- [ ] ç»„ä»¶æ¨¡å‹ (Component Model)

### 12.2 SIMD æ”¯æŒ
- [ ] v128 ç±»å‹
- [ ] SIMD æŒ‡ä»¤é›†
- [ ] å‘é‡åŒ–ä¼˜åŒ–

### 12.3 çº¿ç¨‹æ”¯æŒ
- [ ] å…±äº«å†…å­˜
- [ ] åŸå­æ“ä½œ
- [ ] ç­‰å¾…/é€šçŸ¥

---

## é‡Œç¨‹ç¢‘æ—¶é—´çº¿

| é˜¶æ®µ | ç›®æ ‡ | çŠ¶æ€ |
|------|------|------|
| Phase 1-5 | å®Œæ•´çš„ WASM è§£é‡Šå™¨ | âœ… å·²å®Œæˆ |
| Phase 6 | ä¸­é—´è¡¨ç¤ºå±‚è®¾è®¡ | ğŸ”¨ ä¸‹ä¸€æ­¥ |
| Phase 7 | IR ä¼˜åŒ– | ğŸ“‹ è®¡åˆ’ä¸­ |
| Phase 8-9 | æŒ‡ä»¤é€‰æ‹©ä¸å¯„å­˜å™¨åˆ†é… | ğŸ“‹ è®¡åˆ’ä¸­ |
| Phase 10 | ä»£ç ç”Ÿæˆ | ğŸ“‹ è®¡åˆ’ä¸­ |
| Phase 11 | JIT é›†æˆ | ğŸ“‹ è®¡åˆ’ä¸­ |
| Phase 12 | WASM æ‰©å±• | ğŸ“‹ æœªæ¥è®¡åˆ’ |

---

## å‚è€ƒèµ„æº

### WebAssembly è§„èŒƒ
- [WebAssembly Specification](https://webassembly.github.io/spec/)
- [WASM Binary Encoding](https://webassembly.github.io/spec/core/binary/index.html)
- [WASM Semantics](https://webassembly.github.io/spec/core/exec/index.html)

### Cranelift å‚è€ƒ
- [Cranelift Official Site](https://cranelift.dev/)
- [Cranelift Code Generation Primer](https://bouvier.cc/2021/02/17/cranelift-codegen-primer/)
- [ISLE DSL Reference](https://github.com/bytecodealliance/wasmtime/blob/main/cranelift/isle/docs/language-reference.md)
- [Wasmtime and Cranelift Progress](https://bytecodealliance.org/articles/wasmtime-and-cranelift-in-2023)

### ç¼–è¯‘å™¨è®¾è®¡
- [Engineering a Compiler (Cooper & Torczon)](https://www.elsevier.com/books/engineering-a-compiler/cooper/978-0-12-815412-0)
- [SSA Book](http://ssabook.gforge.inria.fr/latest/book.pdf)

---

**å½“å‰çŠ¶æ€**: Phase 5 å·²å®Œæˆï¼ŒPhase 6 è®¡åˆ’ä¸­
**ä¸‹ä¸€æ­¥**: è®¾è®¡å¹¶å®ç°ä¸­é—´è¡¨ç¤ºå±‚ (IR)
